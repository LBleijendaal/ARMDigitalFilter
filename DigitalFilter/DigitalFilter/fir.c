/*
 * fir.c
 *
 * Created: 28/11/2019 16:41:02
 *  Author: Luuk Bleijendaal
 */ 

#include <stdio.h>

#include "fir.h"

#include "tmwtypes.h"

#include "sam.h"

//F pass: 1000 Hz
//F stop: 3500 Hz
//Fs    : 100 kHz

uint32_t N_coefficients = 101;
float coefficients[101] = {
	4.343378896e-05,-7.904508675e-05,-9.481221787e-05,-0.0001066057157,-8.424618136e-05,
	-1.097615768e-05,0.0001118352957,0.0002600884181,0.0003878968419,0.0004368193331,
	0.0003531037655,0.0001094000982,-0.0002754924935,-0.000726615428,-0.001119173132,
	-0.001303972676,-0.001149039716,-0.0005882257246,0.0003372355422, 0.001459710766,
	0.00250086654, 0.003126225434, 0.003031524131, 0.002042273991,0.0001995289058,
	-0.002197134309,-0.004612111021,-0.006370065734,-0.006814637687,-0.005497841164,
	-0.002353288233, 0.002198317787, 0.007254143246,  0.01156530622,  0.01379342284,
	0.01284338068, 0.008200995624,0.0001916107867,-0.009917165153, -0.02001791447,
	-0.02747719921, -0.02961710654, -0.02427636087, -0.01033500303,  0.01191660762,
	0.04065927491,  0.07272356749,   0.1040499583,   0.1303528994,   0.1478637755,
	0.1540055275,   0.1478637755,   0.1303528994,   0.1040499583,  0.07272356749,
	0.04065927491,  0.01191660762, -0.01033500303, -0.02427636087, -0.02961710654,
	-0.02747719921, -0.02001791447,-0.009917165153,0.0001916107867, 0.008200995624,
	0.01284338068,  0.01379342284,  0.01156530622, 0.007254143246, 0.002198317787,
	-0.002353288233,-0.005497841164,-0.006814637687,-0.006370065734,-0.004612111021,
	-0.002197134309,0.0001995289058, 0.002042273991, 0.003031524131, 0.003126225434,
	0.00250086654, 0.001459710766,0.0003372355422,-0.0005882257246,-0.001149039716,
	-0.001303972676,-0.001119173132,-0.000726615428,-0.0002754924935,0.0001094000982,
	0.0003531037655,0.0004368193331,0.0003878968419,0.0002600884181,0.0001118352957,
	-1.097615768e-05,-8.424618136e-05,-0.0001066057157,-9.481221787e-05,-7.904508675e-05,
	4.343378896e-05
};

float buffer[101];


//F pass: 200 Hz
//F stop: 4150 Hz
//Fs    : 100 kHz

/*
const uint32_t N_coefficients = 51;
const float coefficients[51] = {
	0.0001654817769905, 0.002890976162645,  0.00226828575227, 0.003228241791065,
	0.004271360224449, 0.005493165213566, 0.006891012204096, 0.008460924402888,
	0.01019666751253,  0.01208459879706,  0.01410861605553,  0.01624527864674,
	0.01846733119722,  0.02074452371352,  0.02304200827184,  0.02532158499598,
	0.02754330591101,  0.02966782978311,  0.03165734475424,   0.0334704229473,
	0.0350732342115,  0.03643170898347,   0.0375204190111,  0.03831308001911,
	0.03879493311723,  0.03895897364476,  0.03879493311723,  0.03831308001911,
	0.0375204190111,  0.03643170898347,   0.0350732342115,   0.0334704229473,
	0.03165734475424,  0.02966782978311,  0.02754330591101,  0.02532158499598,
	0.02304200827184,  0.02074452371352,  0.01846733119722,  0.01624527864674,
	0.01410861605553,  0.01208459879706,  0.01019666751253, 0.008460924402888,
	0.006891012204096, 0.005493165213566, 0.004271360224449, 0.003228241791065,
	0.00226828575227, 0.002890976162645,0.0001654817769905
};

static float buffer[51];
*/
static uint32_t offset;

/*
float firFilter(float input)
{
	double output;
	
	for(int i = (N_coefficients - 1); i > 0; i--) {
		buffer[i] = buffer[i-1];
	}
	
	buffer[0] = input;
	
	for(int i = 0; i < N_coefficients; i++) {
		output += buffer[i] * coefficients[i];
	
	}
	

	
	return output;
}
*/

//float *coeff = coefficients;


float firFilter(float input) 
{
	float *coeff = coefficients;
	float *coeff_end = coefficients + N_coefficients;
	
	float *buf_val = buffer + offset;
	
	*buf_val = input;
	
	float output = 0;
	
	while(buf_val >= buffer) 
	{
		output += *buf_val-- * *coeff++;
	}
	
	buf_val = buffer + N_coefficients - 1;
	
	while(coeff < coeff_end)
	{
		output += (*buf_val-- * *coeff++);
	}
	
	if(++offset >= N_coefficients)
	{
		offset = 0;
	}
	
	
	//PIOC->PIO_CODR |= PIO_PC8;
	
	//PIOC->PIO_SODR |= PIO_PC8;
	
	return output;
	
}
