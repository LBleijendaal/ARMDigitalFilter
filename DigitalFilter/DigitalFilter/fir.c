/*
 * fir.c
 *
 * Created: 28/11/2019 16:41:02
 *  Author: Luuk Bleijendaal
 */ 

#include <stdio.h>

#include "fir.h"

#include "tmwtypes.h"

#include "sam.h"

//#include "fircoefficients.h"

//Fpass: 5600	Hz
//Fatt : 6600	Hz
//Fs : 100		kHz
uint32_t N_coefficients = 254;
/*
float coefficients[254] = {
	-9.883039456e-05,-9.956931171e-05,-0.0001310802472,-0.0001496082696,-0.0001424562943,
	-9.50708345e-05,7.614883089e-06,0.0001791217364,0.0004292680242,0.0007619415992,
	0.00117308984, 0.001649221871, 0.002167081228, 0.002693969756,  0.00318992883,
	0.00361057464, 0.003911376465, 0.004052395467, 0.004003298469, 0.003747911425,
	0.003287758911, 0.002643936314,  0.00185702031,0.0009846775793,9.703387332e-05,
	-0.0007298045093,-0.001421587891, -0.00191416312,-0.002161221579,-0.002140600933,
	-0.001858127071,-0.001348485239,-0.0006726083229,8.817432536e-05,0.0008408780559,
	0.001491431845, 0.001956076594, 0.002171968808, 0.002105850959,  0.00175931328,
	0.001169993076,0.0004081638181,-0.0004309703945,-0.001238627825,-0.001906053047,
	-0.002338833641,-0.002469954779,-0.002269916935,-0.001752325916,-0.0009740503156,
	-2.957743163e-05,0.0009599062614, 0.001861614059, 0.002548505785, 0.002916799625,
	0.002901149448, 0.002485448029, 0.001707429532,0.0006562493509,-0.0005371297593,
	-0.001715667546,-0.002716431627, -0.00339256553,-0.003634283319,-0.003385836724,
	-0.002656029304,-0.001520393183,-0.0001143836344, 0.001382062677, 0.002766853897,
	0.003842372913, 0.004442900885, 0.004459206015, 0.003856688738, 0.002684324747,
	0.001072577899,-0.0007799456944,-0.002630010713,-0.004220678937,-0.005315938964,
	-0.005734414328,-0.005377585534,-0.004248258658,-0.002456284827,-0.0002099103003,
	0.002206817735, 0.004468433559, 0.006250168197, 0.007272623014, 0.007343031932,
	0.006387374364, 0.004468372557, 0.001786124543,-0.001339884824,-0.004506102297,
	-0.007274015341,-0.009227336384, -0.01003024634,-0.009478976019,-0.007539527025,
	-0.004365552682, -0.00029275415, 0.004191185813, 0.008498921059,    0.012012925,
	0.0141644692,  0.01451285742,  0.01281498931, 0.009076016024, 0.003573550377,
	-0.00314923143, -0.01032284554, -0.01702047139, -0.02225038968, -0.02506249771,
	-0.02465746924, -0.02048625425, -0.01232822519,-0.000338218204,  0.01494407654,
	0.03262494504,  0.05152583495,  0.07028466463,  0.08747940511,   0.1017613038,
	0.1119839028,    0.117314212,    0.117314212,   0.1119839028,   0.1017613038,
	0.08747940511,  0.07028466463,  0.05152583495,  0.03262494504,  0.01494407654,
	-0.000338218204, -0.01232822519, -0.02048625425, -0.02465746924, -0.02506249771,
	-0.02225038968, -0.01702047139, -0.01032284554, -0.00314923143, 0.003573550377,
	0.009076016024,  0.01281498931,  0.01451285742,   0.0141644692,    0.012012925,
	0.008498921059, 0.004191185813, -0.00029275415,-0.004365552682,-0.007539527025,
	-0.009478976019, -0.01003024634,-0.009227336384,-0.007274015341,-0.004506102297,
	-0.001339884824, 0.001786124543, 0.004468372557, 0.006387374364, 0.007343031932,
	0.007272623014, 0.006250168197, 0.004468433559, 0.002206817735,-0.0002099103003,
	-0.002456284827,-0.004248258658,-0.005377585534,-0.005734414328,-0.005315938964,
	-0.004220678937,-0.002630010713,-0.0007799456944, 0.001072577899, 0.002684324747,
	0.003856688738, 0.004459206015, 0.004442900885, 0.003842372913, 0.002766853897,
	0.001382062677,-0.0001143836344,-0.001520393183,-0.002656029304,-0.003385836724,
	-0.003634283319, -0.00339256553,-0.002716431627,-0.001715667546,-0.0005371297593,
	0.0006562493509, 0.001707429532, 0.002485448029, 0.002901149448, 0.002916799625,
	0.002548505785, 0.001861614059,0.0009599062614,-2.957743163e-05,-0.0009740503156,
	-0.001752325916,-0.002269916935,-0.002469954779,-0.002338833641,-0.001906053047,
	-0.001238627825,-0.0004309703945,0.0004081638181, 0.001169993076,  0.00175931328,
	0.002105850959, 0.002171968808, 0.001956076594, 0.001491431845,0.0008408780559,
	8.817432536e-05,-0.0006726083229,-0.001348485239,-0.001858127071,-0.002140600933,
	-0.002161221579, -0.00191416312,-0.001421587891,-0.0007298045093,9.703387332e-05,
	0.0009846775793,  0.00185702031, 0.002643936314, 0.003287758911, 0.003747911425,
	0.004003298469, 0.004052395467, 0.003911376465,  0.00361057464,  0.00318992883,
	0.002693969756, 0.002167081228, 0.001649221871,  0.00117308984,0.0007619415992,
	0.0004292680242,0.0001791217364,7.614883089e-06,-9.50708345e-05,-0.0001424562943,
	-0.0001496082696,-0.0001310802472,-9.956931171e-05,-9.883039456e-05
};
*/

float buffer[254];

//Fs = 100kHz
//Fpass = 1000 Hz
//Fatt = 2000 Hz
/*
float coefficients[254] = {
	0.0001127638866872,5.258872447114e-05,6.432233996825e-05,7.743160639964e-05,
	9.193977121678e-05,0.0001078825175181,0.0001251986233332,0.0001438785016534,
	0.0001638721820447,0.0001851854290212,0.0002076753429986,0.0002312092845599,
	0.0002556266905118,0.0002809333130031,0.0003067912089944,0.0003329205752461,
	0.0003592774344565, 0.000385338763742,0.0004109865204098,0.0004357938228546,
	0.0004594387904764,0.0004814938857307,0.0005015736566139,0.0005192379910333,
	0.0005340160445849, 0.000545415291304,0.0005529675456555,0.0005561802867306,
	0.0005545100661552,0.0005474973346347,0.0005346037369259,0.0005153059864817,
	0.0004891605402766,  0.00045564613429,0.0004143420856595,0.0003647948944713,
	0.0003066443781628,0.0002395272180168,0.0001631478430975,7.725325460355e-05,
	-1.833895334531e-05,-0.0001237714843585,-0.0002390884659535,-0.0003642613928139,
	-0.000499215754338,-0.0006437463682842,-0.0007975828959086,-0.0009603617051703,
	-0.001131605492449,-0.001310759986443,-0.001497141127365,-0.001689991052861,
	-0.001888418738893, -0.00209144973379,-0.002298001543363,-0.002506898281176,
	-0.002716844747785,-0.002926476863958, -0.00313432613637,-0.003338833967014,
	-0.003538380602386,-0.003731256455036,-0.003915699275119,-0.004089890199289,
	-0.004251966594503,-0.004400036978721,-0.004532172112694,-0.004646450107474,
	-0.004740939834031,-0.004813728053306,-0.004862924680893,-0.004886691555858,
	-0.004883226562404,-0.004850813208471,-0.004787811085181,-0.004692672722135,
	-0.004563966760381,-0.004400381455828,-0.004200749570514,-0.003964046150774,
	-0.003689410287007,-0.003376157547862,-0.003023777936642,-0.002631960566644,
	-0.002200594126587,-0.001729773860423,-0.001219804399356,-0.0006712209665307,
	-8.476945064789e-05,0.0005385727019672, 0.001197607257898, 0.001890909271305,
	0.002616832244233, 0.003373513658315, 0.004158872582577, 0.004970628399749,
	0.005806302647856, 0.006663224852563,  0.00753855138997, 0.008429276797522,
	0.0093322434851,  0.01024415868329,  0.01116161565972,   0.0120811012082,
	0.01299902457523,  0.01391172899815,  0.01481551838332,  0.01570666800185,
	0.01658145243345,  0.01743616790462,  0.01826714656537,  0.01907078197303,
	0.01984355165747,   0.0205820347297,  0.02128293253331,  0.02194309271435,
	0.02255952332072,  0.02312941051187,  0.02365013937529,  0.02411930925049,
	0.02453474675148,  0.02489451715407,  0.02519694287461,  0.02544060712841,
	0.02562436540602,  0.02574735426683,  0.02580899501229,  0.02580899501229,
	0.02574735426683,  0.02562436540602,  0.02544060712841,  0.02519694287461,
	0.02489451715407,  0.02453474675148,  0.02411930925049,  0.02365013937529,
	0.02312941051187,  0.02255952332072,  0.02194309271435,  0.02128293253331,
	0.0205820347297,  0.01984355165747,  0.01907078197303,  0.01826714656537,
	0.01743616790462,  0.01658145243345,  0.01570666800185,  0.01481551838332,
	0.01391172899815,  0.01299902457523,   0.0120811012082,  0.01116161565972,
	0.01024415868329,   0.0093322434851, 0.008429276797522,  0.00753855138997,
	0.006663224852563, 0.005806302647856, 0.004970628399749, 0.004158872582577,
	0.003373513658315, 0.002616832244233, 0.001890909271305, 0.001197607257898,
	0.0005385727019672,-8.476945064789e-05,-0.0006712209665307,-0.001219804399356,
	-0.001729773860423,-0.002200594126587,-0.002631960566644,-0.003023777936642,
	-0.003376157547862,-0.003689410287007,-0.003964046150774,-0.004200749570514,
	-0.004400381455828,-0.004563966760381,-0.004692672722135,-0.004787811085181,
	-0.004850813208471,-0.004883226562404,-0.004886691555858,-0.004862924680893,
	-0.004813728053306,-0.004740939834031,-0.004646450107474,-0.004532172112694,
	-0.004400036978721,-0.004251966594503,-0.004089890199289,-0.003915699275119,
	-0.003731256455036,-0.003538380602386,-0.003338833967014, -0.00313432613637,
	-0.002926476863958,-0.002716844747785,-0.002506898281176,-0.002298001543363,
	-0.00209144973379,-0.001888418738893,-0.001689991052861,-0.001497141127365,
	-0.001310759986443,-0.001131605492449,-0.0009603617051703,-0.0007975828959086,
	-0.0006437463682842,-0.000499215754338,-0.0003642613928139,-0.0002390884659535,
	-0.0001237714843585,-1.833895334531e-05,7.725325460355e-05,0.0001631478430975,
	0.0002395272180168,0.0003066443781628,0.0003647948944713,0.0004143420856595,
	0.00045564613429,0.0004891605402766,0.0005153059864817,0.0005346037369259,
	0.0005474973346347,0.0005545100661552,0.0005561802867306,0.0005529675456555,
	0.000545415291304,0.0005340160445849,0.0005192379910333,0.0005015736566139,
	0.0004814938857307,0.0004594387904764,0.0004357938228546,0.0004109865204098,
	0.000385338763742,0.0003592774344565,0.0003329205752461,0.0003067912089944,
	0.0002809333130031,0.0002556266905118,0.0002312092845599,0.0002076753429986,
	0.0001851854290212,0.0001638721820447,0.0001438785016534,0.0001251986233332,
	0.0001078825175181,9.193977121678e-05,7.743160639964e-05,6.432233996825e-05,
	5.258872447114e-05,0.0001127638866872
};
*/

/*
float coefficients[254] = {
	-5.451592300996e-05,0.0002415186238531,6.863492113389e-05,-8.608022249657e-05,
	-2.778463020947e-05,0.0001151740396858,2.321769744998e-05,-0.0001377268352908,
	-1.311849002184e-05,0.0001623866484365,-1.228351060593e-06,-0.0001883208643453,
	2.049853957741e-05,0.0002150462872596,-4.530264632412e-05,-0.0002418715617999,
	7.613662119273e-05,0.0002680708677417,-0.0001134999568618,-0.0002927206157985,
	0.0001577631166114,0.0003148437960441,-0.0002093028482002,-0.0003332642389639,
	0.0002682530937316,0.0003467347010715,-0.0003346927114747,-0.0003538710964132,
	0.0004083899974669,0.0003533556462458,-0.0004890788961594,-0.0003437241096758,
	0.0005762040005974,0.0003234794791121,-0.000669169310716,-0.0002908777166136,
	0.0007666587026667,0.0002446221898107,-0.0008676488281312,-0.0001832050198902,
	0.000970707537666,0.0001050757686433,-0.001073831980979,-9.211813537241e-06,
	0.001175248462375,-0.0001056676977668,-0.001272465702629,0.0002404164409228,
	0.001363043580301,-0.0003958238913309,-0.001444174190633, 0.000572261183401,
	0.001512945608783,-0.0007698721586423,-0.001566104841471,0.0009884236763224,
	0.001600290206788,-0.001227425771942,-0.001611930000223, 0.001485952597512,
	0.001597506588372,-0.001762584560397,-0.001553307248587, 0.002055401232667,
	0.001475521084274,-0.002362251412572,-0.001360396041049,  0.00268041191836,
	0.001204348005891,-0.003006453647592, -0.00100360121875, 0.003336707796247,
	0.0007545980606163,-0.003667112696278,-0.0004540479925391, 0.003992525624935,
	9.846443930541e-05,-0.004308081332282, 0.000315118121949, 0.004607702630758,
	-0.0007898782395077,-0.004885227746305,  0.00132860403739,  0.00513373644975,
	-0.001934165968901,-0.005345791246562, 0.002609358077172, 0.005513287863214,
	-0.00335713484922,-0.005627419259058, 0.004180698612351, 0.005678481788168,
	-0.005083763413307,-0.005655701323824, 0.006070864221218, 0.005546935092155,
	-0.007147798129192,-0.005338157011504, 0.008322322958353, 0.005012803237998,
	-0.009605041465856,-0.004550670947107,  0.01101085478332, 0.003926386498699,
	-0.01256104315085,-0.003106683596406,  0.01428673423827, 0.002046362593379,
	-0.01623419114102,-0.000681033229335,  0.01847474096615,-0.001085391438277,
	-0.02112169289327, 0.003404753231436,   0.0243644983489,-0.006533490892623,
	-0.02854144042746,   0.0109434864731,  0.03431452383597, -0.01761011618876,
	-0.04316797222161,  0.02892876491945,  0.05923478306211, -0.05277387924431,
	-0.09989135092343,    0.139030052997,   0.4606211983636,   0.4606211983636,
	0.139030052997, -0.09989135092343, -0.05277387924431,  0.05923478306211,
	0.02892876491945, -0.04316797222161, -0.01761011618876,  0.03431452383597,
	0.0109434864731, -0.02854144042746,-0.006533490892623,   0.0243644983489,
	0.003404753231436, -0.02112169289327,-0.001085391438277,  0.01847474096615,
	-0.000681033229335, -0.01623419114102, 0.002046362593379,  0.01428673423827,
	-0.003106683596406, -0.01256104315085, 0.003926386498699,  0.01101085478332,
	-0.004550670947107,-0.009605041465856, 0.005012803237998, 0.008322322958353,
	-0.005338157011504,-0.007147798129192, 0.005546935092155, 0.006070864221218,
	-0.005655701323824,-0.005083763413307, 0.005678481788168, 0.004180698612351,
	-0.005627419259058, -0.00335713484922, 0.005513287863214, 0.002609358077172,
	-0.005345791246562,-0.001934165968901,  0.00513373644975,  0.00132860403739,
	-0.004885227746305,-0.0007898782395077, 0.004607702630758, 0.000315118121949,
	-0.004308081332282,9.846443930541e-05, 0.003992525624935,-0.0004540479925391,
	-0.003667112696278,0.0007545980606163, 0.003336707796247, -0.00100360121875,
	-0.003006453647592, 0.001204348005891,  0.00268041191836,-0.001360396041049,
	-0.002362251412572, 0.001475521084274, 0.002055401232667,-0.001553307248587,
	-0.001762584560397, 0.001597506588372, 0.001485952597512,-0.001611930000223,
	-0.001227425771942, 0.001600290206788,0.0009884236763224,-0.001566104841471,
	-0.0007698721586423, 0.001512945608783, 0.000572261183401,-0.001444174190633,
	-0.0003958238913309, 0.001363043580301,0.0002404164409228,-0.001272465702629,
	-0.0001056676977668, 0.001175248462375,-9.211813537241e-06,-0.001073831980979,
	0.0001050757686433, 0.000970707537666,-0.0001832050198902,-0.0008676488281312,
	0.0002446221898107,0.0007666587026667,-0.0002908777166136,-0.000669169310716,
	0.0003234794791121,0.0005762040005974,-0.0003437241096758,-0.0004890788961594,
	0.0003533556462458,0.0004083899974669,-0.0003538710964132,-0.0003346927114747,
	0.0003467347010715,0.0002682530937316,-0.0003332642389639,-0.0002093028482002,
	0.0003148437960441,0.0001577631166114,-0.0002927206157985,-0.0001134999568618,
	0.0002680708677417,7.613662119273e-05,-0.0002418715617999,-4.530264632412e-05,
	0.0002150462872596,2.049853957741e-05,-0.0001883208643453,-1.228351060593e-06,
	0.0001623866484365,-1.311849002184e-05,-0.0001377268352908,2.321769744998e-05,
	0.0001151740396858,-2.778463020947e-05,-8.608022249657e-05,6.863492113389e-05,
	0.0002415186238531,-5.451592300996e-05
};

*/




static uint32_t offset;

float firFilter(float input, float *coefficients) 
{
	//PIOC->PIO_CODR |= PIO_PC8;
	
	float *coeff = coefficients;
	float *coeff_end = coefficients + N_coefficients;
	
	float *buf_val = buffer + offset;
	
	*buf_val = input;
	
	float output = 0;
	
	while(buf_val >= buffer) 
	{
		output += *buf_val-- * *coeff++;
	}
	
	buf_val = buffer + N_coefficients - 1;
	
	while(coeff < coeff_end)
	{
		output += (*buf_val-- * *coeff++);
	}
	
	if(++offset >= N_coefficients)
	{
		offset = 0;
	}
	
	//PIOC->PIO_SODR |= PIO_PC8;
	
	return output;
	
}
